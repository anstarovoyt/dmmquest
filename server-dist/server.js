var all_text = {
    stages: [
        {
            name: "Этап «Мост Макарова»",
            quests: [
                "\u0411\u0443\u0440\u044F \u043C\u0433\u043B\u043E\u044E \u043D\u0435\u0431\u043E \u043A\u0440\u043E\u0435\u0442,<br> \n\u0412\u0438\u0445\u0440\u0438 \u0441\u043D\u0435\u0436\u043D\u044B\u0435 \u043A\u0440\u0443\u0442\u044F,<br>\n\u0414\u0432\u0438\u0433\u0430\u0439\u0442\u0435 \u0441\u0432\u043E\u0435\u0439 \u0442\u043E\u043B\u043F\u043E\u044E<br>\n\u041E\u0442 \u0420\u0435\u043F\u0435\u0440\u0430 \u0434\u043E \u041C\u0435\u043D\u044F.<br>\n\u0413\u0434\u0435 \u043F\u043E\u0434 \u043A\u0440\u043E\u0432\u043B\u0435\u0439 \u043E\u0431\u0432\u0435\u0442\u0448\u0430\u043B\u043E\u0439<br> \n\u0414\u0440\u0435\u0432\u043E \u0447\u0443\u0434\u043D\u043E\u0435 \u0441\u0442\u043E\u0438\u0442,<br>\n\u0428\u0430\u0445\u043C\u0430\u0442\u0438\u0441\u0442 \u2013 \u0441\u043F\u043E\u0440\u0442\u0441\u043C\u0435\u043D \u0431\u044B\u0432\u0430\u043B\u044B\u0439<br>\n\u0422\u0430\u043C \u043F\u0440\u043E\u0432\u043E\u0434\u0438\u0442 \u0441\u0432\u043E\u0439 \u0433\u0430\u043C\u0431\u0438\u0442.<br>\n\u0412\u044B\u043F\u044C\u0435\u043C, \u0434\u043E\u0431\u0440\u0430\u044F \u043F\u043E\u0434\u0440\u0443\u0436\u043A\u0430,<br>\n\u041D\u0443\u0436\u0435\u043D \u043D\u043E\u043C\u0435\u0440 \u0438\u0433\u0440\u043E\u043A\u0430.<br>\n\u0412\u044B\u043F\u044C\u0435\u043C \u0441 \u0433\u043E\u0440\u044F; \u0413\u0434\u0435 \u0436\u0435 \u043A\u0440\u0443\u0436\u043A\u0430?<br>\n\u042F \u0437\u0430 \u043A\u0440\u0443\u0436\u043A\u043E\u0439. \u0412\u0441\u0435\u043C \u043F\u043E\u043A\u0430.",
                "\u041F\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u044C\u0442\u0435: exp((-(((x-4)^2+(y-4)^2)^2))/1000)+exp((-(((x+4)^2+(y+4)^2)^2))/1000)+0.15*exp(-(((x+4)^2+(y+4)^2)^2))+0.15*exp(-(((x-4)^2+(y-4)^2)^2)) \n\u041F\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u0438\u043B\u0438? \u0412\u043E\u0437\u044C\u043C\u0438\u0442\u0435 \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u0434\u043D\u0443. \u041F\u043E\u0434\u043E\u0439\u0434\u0438\u0442\u0435 \u0432 \u043F\u043B\u043E\u0442\u043D\u0443\u044E \u043A \u043C\u043E\u0440\u044E. \u0427\u0442\u043E \u0434\u0435\u043B\u0430\u043B \u043D\u0438\u043A\u043D\u0435\u0439\u043C, \u043A\u043E\u0433\u0434\u0430 \u043A\u0442\u043E-\u0442\u043E \u043B\u043E\u0436\u0438\u043B\u0441\u044F \u0441\u043F\u0430\u0442\u044C?",
                "\u042D\u0442\u0430 \u0443\u043B\u0438\u0446\u0430 \u043C\u0435\u043D\u044F\u043B\u0430 \u0441\u0432\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u0440\u0430\u0437. \u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0435\u0435 \u043F\u0435\u0440\u0435\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435 \u043F\u043E\u0437\u0436\u0435 \u0441\u0442\u0430\u043B\u043E \u0441\u0432\u044F\u0437\u0430\u043D\u043E \u0441 \u0423\u0440\u0413\u0423. \u041D\u0430\u0439\u0434\u0438\u0442\u0435 \u0446\u0435\u043D\u0442\u0440 \u0443\u043B\u0438\u0446\u044B. \u0421\u043A\u043E\u043B\u044C\u043A\u043E \u0441\u043A\u0430\u043C\u0435\u0435\u043A \u043E\u043A\u0440\u0443\u0436\u0430\u044E\u0442 \u043C\u043D\u043E\u0433\u043E\u0433\u0440\u0430\u043D\u043D\u0443\u044E \u043A\u043E\u0441\u0442\u0440\u0443\u043A\u0446\u0438\u044E?",
                "В конце своих приключений Буратино приобрел его, который обязательно бы подошёл к нему. Крупнейшая в Екатеринбурге выставка их соединяет два музея. Переехавший относительно недавно каменный мужик смотрит на нужный. Какой ползучий гад спрятался на камнях возле?",
                "\u0410\u0443\u0434\u0438\u043E\u0444\u0430\u0439\u043B. \u0417\u0430\u0433\u0430\u0434\u0430\u043D\u043E \u043C\u0435\u0441\u0442\u043E. \u0421\u043A\u043E\u043B\u044C\u043A\u043E \u043F\u0435\u0440\u044C\u0435\u0432, \u0442\u043E\u0440\u0447\u0430\u0449\u0438\u0445 \u0438\u0437 \u043A\u043B\u0435\u0442\u043A\u0438 \u0438\u043C\u0435\u044E\u0442 \u0441\u043F\u0438\u0440\u0430\u043B\u044C?\n<br>\n<iframe width=\"280\" height=\"157\" src=\"https://www.youtube.com/embed/yRrJDeh4x-w\" frameborder=\"0\" allowfullscreen></iframe>\n\n<br>\n<br>\n<a style=\"text-decoration:underline !important\" href=\"https://youtu.be/yRrJDeh4x-w\">YouTube link</a>\n                ",
                "Единственный NPC в квесте. На Набережной Рабочей Молодёжи между домами 1 и 3 стоит белый фольксваген 898, там всю команду ждут Машенька и Петенька."
            ]
        },
        {
            name: "Этап «Физра не в Павлике»",
            quests: [
                "Сколько ещё говядины надо добавить, чтобы про них можно было петь песню?<br><img style='height: auto;width: auto; max-width: 250px;max-height: 250px;' src='/statics/letters.png'/>",
                "Опытный программист найдёт это место вслепую: (2,5) (2,8) (2,7) (1,9) (2,4) (2,9) (3,7)         (2,7) (3,8) (2,7) (2,6) (2,7) (1,6) (2,2). Идите к зданию полному opium des volkes. Сколько трёхмерных гауссиан перед вами?",
                {
                    type: 1 /* UPLOAD */, text: "\u0417\u0434\u0435\u0441\u044C\n<br>\n<br>\n<img style='height: auto;width: auto; max-width: 200px;max-height: 200px;' src='/statics/sun.png'/>\n<br>\n\u043D\u0430\u0439\u0434\u0438\u0442\u0435 \u0441\u0430\u043C\u0443\u044E \u0432\u044B\u0441\u043E\u043A\u0443\u044E \u043F\u043B\u043E\u0449\u0430\u0434\u043A\u0443.\n\u0421\u0440\u0435\u0434\u0438 \u0438\u0437\u043B\u044E\u0431\u043B\u0435\u043D\u043D\u044B\u0445 \u043F\u0440\u0435\u0434\u043C\u0435\u0442\u043E\u0432 \u0431\u0430\u0431\u0443\u0448\u0435\u043A \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0446\u0435\u043D\u0442\u0440\u0430\u043B\u044C\u043D\u044B\u0439. \u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0444\u043E\u0442\u043E, \u0441\u043B\u0435\u0434\u0443\u044F \u0438\u043D\u0441\u0442\u0440\u0443\u043A\u0446\u0438\u044F\u043C."
                },
                "На улице папиного уральца найдите салон, сочетающий красоту с орфографией. Следуя указателю ароматного пара, разыщите предмет-очевидность. Назовите аргументы коньюкции?",
                "Самое время подкрепиться! Встаньте напротив места, где это можно сделать сыто и с огоньком. Пройдите мимо того, чего хотят все проигравшие. Напротив человека, убаюкивающего луну, узнайте какое расстояние от фасада является безопасным?"
            ]
        },
        {
            name: "Этап «тУПИк»",
            quests: [
                "Много ли есть в Екатеринбурге памятников, которые стоят на \"своих\" улицах? На одной из таких улиц мы загадали дом с чётным номером N. N mod 100 + N div 100 +1 = M, где M - номер средней образовательной школы в этом доме. Сколько свободных рук у памятника перед ним?",
                "Это место находится между тремя улицами. Первая названа в честь первого, вторая связана с первым пятого, третья носит имя первого кавалера Ордена Красного Знамени. С третьей улицы через автомобильный въезд загляните внутрь и ответьте, почему въезд запрещён?",
                "\n\u0412 \u044D\u0442\u043E \u0441\u043B\u043E\u0436\u043D\u043E \u043F\u043E\u0432\u0435\u0440\u0438\u0442\u044C, \u043D\u043E \u0443 \u041F\u0443\u0448\u043A\u0438\u043D\u0430 \u0438 \u0432\u043E\u0442 \u044D\u0442\u0438\u0445 \u0434\u0435\u0432\u0443\u0448\u0435\u043A \u0435\u0441\u0442\u044C \u043D\u0435\u0447\u0442\u043E \u043E\u0431\u0449\u0435\u0435. \n<br>\n<img style='height: auto;width: auto; max-width: 200px;max-height: 200px;' src='/statics/girls.jpg'/>\n<br>\n\u041D\u043E\u043C\u0435\u0440 \u044D\u0442\u043E\u0433\u043E \u043E\u0431\u0449\u0435\u0433\u043E \u0441\u043E\u0441\u0442\u043E\u0438\u0442 \u0438\u0437 \u0434\u0432\u0443\u0445 \u0446\u0438\u0444\u0440. \u041F\u0435\u0440\u0432\u0430\u044F - \u0432\u0442\u043E\u0440\u043E\u0435 \u043D\u0430\u0442\u0443\u0440\u0430\u043B\u044C\u043D\u043E\u0435 \u0447\u0438\u0441\u043B\u043E, \u044F\u0432\u043B\u044F\u044E\u0449\u0435\u0435\u0441\u044F \u0442\u0440\u0435\u0442\u044C\u0435\u0439 \u0441\u0442\u0435\u043F\u0435\u043D\u044C\u044E \u043A\u0430\u043A\u043E\u0433\u043E-\u043B\u0438\u0431\u043E \u0434\u0440\u0443\u0433\u043E\u0433\u043E \u043D\u0430\u0442\u0443\u0440\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u0447\u0438\u0441\u043B\u0430; \u0432\u0442\u043E\u0440\u043E\u0435 \u2013 \u0441\u0443\u043C\u043C\u0430 \u0446\u0438\u0444\u0440 \u0441\u0430\u043C\u043E\u0433\u043E \u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E\u0433\u043E \u043F\u0440\u0438\u0431\u043B\u0438\u0436\u0435\u043D\u0438\u044F \u0447\u0438\u0441\u043B\u0430 \u043F\u0438.\n\u041D\u0430 \u0441\u0435\u0432\u0435\u0440\u043E-\u0432\u043E\u0441\u0442\u043E\u043A\u0435 \u043E\u0442 \u043D\u0435\u0433\u043E \u0434\u043E\u0440\u043E\u0436\u043D\u044B\u0439 \u0443\u043A\u0430\u0437\u0430\u0442\u0435\u043B\u044C. \u0420\u0430\u0441\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0434\u043E \u043C\u0435\u0434\u0432\u0435\u0436\u044C\u0435\u0439 \u043F\u0430\u0434\u0438?",
                "\n\u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0435\u043C \u0432\u0441\u043F\u043E\u043C\u043D\u0438\u0442\u044C \u0442\u0435\u043E\u0440\u0438\u044E \u0432\u0435\u0440\u043E\u044F\u0442\u043D\u043E\u0441\u0442\u0438. \n<br>\n<br>\n<img style='height: auto;width: auto; max-width: 250px;max-height: 250px;' src='/statics/formula.png'/>    \n<br>\n<br>\n\u0422\u0430\u043A \u0438 \u0431\u044B\u0442\u044C, \u043E\u0442 \u0432\u0430\u0441 \u043D\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u043F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C \u044D\u0442\u043E \u043D\u0435\u0440\u0430\u0432\u0435\u043D\u0441\u0442\u0432\u043E, \u043D\u043E \u0445\u043E\u0442\u044F \u0431\u044B \u0430\u0432\u0442\u043E\u0440\u0430 \u043F\u0440\u0438\u043F\u043E\u043C\u043D\u0438\u0442\u0435? :) \n\u0421\u044E\u0440\u043F\u0440\u0438\u0437-\u0441\u044E\u0440\u043F\u0440\u0438\u0437, \u0435\u0433\u043E \u0438\u043C\u0435\u043D\u0435\u043C \u043D\u0430\u0437\u0432\u0430\u043D\u0430 \u0443\u043B\u0438\u0446\u0430 \u0432 \u043D\u0430\u0448\u0435\u043C \u0433\u043E\u0440\u043E\u0434\u0435! \n\u0410 \u043D\u0430 \u0431\u043B\u0438\u0436\u0430\u0439\u0448\u0435\u0439 \u043F\u0430\u0440\u0430\u043B\u043B\u0435\u043B\u044C\u043D\u043E\u0439 \u0443\u043B\u0438\u0446\u0435 \u043D\u0430 \u0437\u0430\u043F\u0430\u0434\u0435 \u043D\u0430\u0445\u043E\u0434\u0438\u0442\u0441\u044F \u043D\u0435\u0431\u043E\u043B\u044C\u0448\u0430\u044F \u0430\u043B\u043B\u0435\u0439\u043A\u0430. \n\u041F\u043E\u0441\u0440\u0435\u0434\u0438 \u043D\u0435\u0451 \u2013 \u0442\u0435\u0445\u043D\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u0437\u0434\u0430\u043D\u0438\u0435 \u0441 \u0433\u0440\u0430\u0444\u0444\u0438\u0442\u0438, \u043A\u043E\u0442\u043E\u0440\u043E\u0435 \u0432\u0430\u043C \u0438 \u043D\u0443\u0436\u043D\u043E. \n\u0421\u043F\u0440\u0430\u0432\u0430 \u043E\u0442 \u0446\u0435\u043D\u0442\u0440\u0430\u043B\u044C\u043D\u043E\u0439 \u0434\u0435\u0432\u0443\u0448\u043A\u0438, \u043F\u0435\u0440\u0432\u044B\u0435 \u0447\u0435\u0442\u044B\u0440\u0435 \u0431\u0443\u043A\u0432\u044B \u043F\u043E\u0441\u043B\u0435 \u0442\u0440\u0435\u0443\u0433\u043E\u043B\u044C\u043D\u0438\u043A\u0430? \n",
                "\n\u042D\u0441\u0442\u0430\u0444\u0435\u0442\u0430.\n<br>\n\u041F\u043E\u043B\u0443\u0447\u0430\u0435\u0448\u044C \u0444\u043E\u0442\u043E \u2013 \u0434\u0435\u043B\u0430\u0435\u0448\u044C \u0441\u0435\u043B\u0444\u0438 \u0432 \u0442\u043E\u043C \u0436\u0435 \u043C\u0435\u0441\u0442\u0435 \u2013 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u0435\u0448\u044C \u0432 \u0447\u0430\u0442\u0438\u043A \u2013 \u043F\u043E\u043B\u0443\u0447\u0430\u0435\u0448\u044C \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u0435.<br> \n\u041C\u0435\u043D\u044C\u0448\u0435 15 \u043C\u0438\u043D\u0443\u0442 \u2013 1,5 \u0431\u0430\u043B\u043B\u0430, 15-25 \u043C\u0438\u043D\u0443\u0442 \u2013 1 \u0431\u0430\u043B\u043B, \u0431\u043E\u043B\u044C\u0448\u0435 25 \u043C\u0438\u043D\u0443\u0442 \u2013 0,5 \u0431\u0430\u043B\u043B\u043E\u0432.<br> \n <br>\n <br>\n \u041C\u0438\u0440\u0430 22, \u043F\u0435\u0440\u0432\u043E\u0435 \u0444\u043E\u0442\u043E:\n <br>\n<img style='height: auto;width: auto; max-width: 200px;max-height: 200px;' src='/statics/point.jpg'/>  \n<a style=\"text-decoration:underline !important\" href=\"https://pp.vk.me/c630219/v630219250/23f16/Z_6q4GDzGYE.jpg\">High resolution link</a>\n<br> \u041D\u0430 \u043F\u0435\u0440\u0432\u043E\u043C \u0444\u043E\u0442\u043E \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u044D\u0441\u0442\u0430\u0444\u0435\u0442\u044B.\n\n                "
            ]
        }
    ],
    bonus: {
        name: "Для задротов",
        status: 3 /* BONUS */,
        quests: [
            "\u0417\u0430\u0434\u0430\u0447\u0430 \u043D\u0430 \u043F\u043E\u0441\u0442\u0440\u043E\u0435\u043D\u0438\u0435: \u043F\u043E\u0441\u0442\u0440\u043E\u0439\u0442\u0435 \u043E\u043A\u0440\u0443\u0436\u043D\u043E\u0441\u0442\u044C \u0445^2+\u0443^2=1 \u0438 \u0432\u0441\u043F\u043E\u043C\u043E\u0433\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u0439 \u0433\u0440\u0430\u0444\u0438\u043A \u0443=-(\u0445^2+\u0443^2)/2. \u0418\u0437 (0;0) \u043F\u043E\u0441\u0442\u0440\u043E\u0439\u0442\u0435 \u0442\u0440\u0438 \u0435\u0434\u0438\u043D\u0438\u0447\u043D\u044B\u0445 \u043E\u0442\u0440\u0435\u0437\u043A\u0430. \u041F\u0435\u0440\u0432\u044B\u0439 \u0441\u043E\u0435\u0434\u0438\u043D\u0438\u0442\u0435 \u0441 (0;1), \u0430 \u0432\u0442\u043E\u0440\u043E\u0439 \u0438 \u0442\u0440\u0435\u0442\u0438\u0439 \u0441 \u0442\u043E\u0447\u043A\u0430\u043C\u0438 \u043F\u0435\u0440\u0435\u0441\u0435\u0447\u0435\u043D\u0438\u044F \u043E\u043A\u0440\u0443\u0436\u043D\u043E\u0441\u0442\u0438 \u0438 \u0432\u0441\u043F\u043E\u043C\u043E\u0433\u0430\u0442\u0435\u043B\u044C\u043D\u043E\u0433\u043E \u0433\u0440\u0430\u0444\u0438\u043A\u0430. \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430: \u0435\u0434\u0438\u043D\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u0442\u0435\u043B\u0435\u0444\u043E\u043D \u0437\u0430\u043A\u0430\u043D\u0447\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u043D\u0430 10. \u0411\u043B\u0438\u0436\u0430\u0439\u0448\u0438\u0439 \u0445\u043E\u0437\u044F\u0439\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043A\u043E\u0440\u043F\u0443\u0441, \u043D\u043E\u043C\u0435\u0440 \u0432\u043E\u0437\u043B\u0435 \u0421\u043A\u0440\u0430\u0442\u0430. \n\n<br>\n<br>\n1 \u0431\u0430\u043B\u043B\n", "\n\u042D\u0442\u0430 \u043E\u0440\u0433\u0430\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u043D\u043E\u0441\u0438\u0442 \u0436\u0435\u043B\u0435\u0437\u043D\u043E\u0434\u043E\u0440\u043E\u0436\u043D\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435, \u043D\u043E \u043F\u0440\u0438 \u044D\u0442\u043E\u043C \u0441\u0432\u044F\u0437\u0430\u043D\u0430 \u0441 \u043F\u043B\u0430\u0432\u0441\u0440\u0435\u0434\u0441\u0442\u0432\u0430\u043C\u0438. \u041D\u0430\u0439\u0434\u0438\u0442\u0435 \u0431\u043B\u0438\u0436\u0430\u0439\u0448\u0443\u044E \u0441\u0442\u0435\u043D\u0443 \u0441 \u0441\u0430\u043C\u043E\u0432\u044B\u0440\u0430\u0436\u0435\u043D\u0438\u044F\u043C\u0438 \u043D\u0430 \u0441\u0435\u0432\u0435\u0440\u043E-\u0437\u0430\u043F\u0430\u0434\u0435. \u041A\u0430\u043A\u043E\u0433\u043E \u0446\u0432\u0435\u0442\u0430 \u0433\u0440\u0438\u0432\u0430 \u0443 \u043B\u044C\u0432\u0430?\n<br>\n<br>\n2 \u0431\u0430\u043B\u043B\u0430\n            ", "\n\u0418\u043C\u0435\u043D\u043D\u043E \u0432 \u0441\u0442\u0435\u043D\u0430\u0445 \u044D\u0442\u043E\u0433\u043E \u0443\u043D\u0438\u0432\u0435\u0440\u0430 \u0421\u0438\u0437\u044B\u0439 (\u044D\u0442\u043E \u043D\u0435 \u043F\u043E\u0433\u043E\u043D\u044F\u043B\u043E!) \u0437\u0430\u0449\u0438\u0449\u0430\u043B \u0441\u0432\u043E\u044E \u0434\u043E\u043A\u0442\u043E\u0440\u0441\u043A\u0443\u044E. \u041D\u0430\u0439\u0434\u0438\u0442\u0435 \u043F\u0435\u0448\u0435\u0445\u043E\u0434\u043D\u044B\u0439 \u043C\u043E\u0441\u0442. \u0417\u0430\u043F\u0438\u0448\u0438\u0442\u0435 \u0435\u0433\u043E \u0438\u043D\u0432\u0435\u043D\u0442\u0430\u0440\u043D\u044B\u0439 \u043D\u043E\u043C\u0435\u0440 \u0432 \u0434\u0435\u0441\u044F\u0442\u0438\u0447\u043D\u043E\u0439 \u0441\u0438\u0441\u0442\u0435\u043C\u0435\n<br>\n<br>\n1 \u0431\u0430\u043B\u043B\n            ",
            "\n\u0415\u0441\u043B\u0438 \u0432\u044B \u0443\u0447\u0438\u043B\u0438\u0441\u044C \u043D\u0430 \u043C\u0430\u0442\u043C\u0435\u0445\u0435, \u0442\u043E \u043A\u043E\u0433\u0434\u0430-\u0442\u043E \u0432\u044B \u0431\u044B\u043B\u0438 (\u0438\u043B\u0438 \u0432\u0441\u0451 \u0435\u0449\u0451 \u044F\u0432\u043B\u044F\u0435\u0442\u0435\u0441\u044C) \u0438\u043C\u0438. \u0412 \u0447\u0435\u0441\u0442\u044C \u043D\u0438\u0445 \u043D\u0430\u0437\u0432\u0430\u043D\u0430 \u043E\u0434\u043D\u0430 \u0438\u0437 \u0443\u043B\u0438\u0446 \u0415\u043A\u0430\u0442\u0435\u0440\u0438\u043D\u0431\u0443\u0440\u0433\u0430.\n<br>\n\u0414\u0430\u043D\u043E: \u0440\u0430\u0432\u043D\u043E\u0441\u0442\u043E\u0440\u043E\u043D\u043D\u0438\u0439 \u0442\u0440\u0435\u0443\u0433\u043E\u043B\u044C\u043D\u0438\u043A, P=18. \u0417\u0430\u0433\u0430\u0434\u0430\u043D\u043E \u043C\u0435\u0441\u0442\u043E. \u0421\u043A\u043E\u043B\u044C\u043A\u043E \u0432\u0441\u0435\u0433\u043E \u0441\u043A\u0430\u043C\u0435\u0435\u043A \u0431\u044B\u043B\u043E \u0432 \u044D\u0442\u043E\u043C \u043C\u0435\u0441\u0442\u0435 \u043F\u043E \u0437\u0430\u0434\u0443\u043C\u043A\u0435 \u0430\u0440\u0445\u0438\u0442\u0435\u043A\u0442\u043E\u0440\u0430?\n<br>\n<img style='height: auto;width: auto; max-width: 250px;max-height: 250px;' src='/statics/triangle.png'/>\n<br>\n<br>\n2 \u0431\u0430\u043B\u043B\u0430\n            ",
            "\n\u0412\u0441\u0442\u0430\u043D\u044C \u043F\u0435\u0440\u0435\u0434 \u0437\u043D\u0430\u043A\u043E\u043C \u043E\u0431\u0435\u0440\u0435\u0433\u0430 \u0442\u0430\u043A, \u0447\u0442\u043E\u0431\u044B \u0442\u0430\u0431\u043B\u0438\u0447\u043A\u0430 \u043E \u043D\u0451\u043C \u0431\u044B\u043B\u0430 \u0441\u043F\u0440\u0430\u0432\u0430 \u043E\u0442 \u0442\u0435\u0431\u044F. 15 \u0448\u0430\u0433\u043E\u0432 \u0432\u043F\u0435\u0440\u0451\u0434, \u0437\u0430\u0442\u0435\u043C 22 \u0441\u0442\u0443\u043F\u0435\u043D\u044C\u043A\u0438 \u043F\u043E \u043B\u0435\u0441\u0442\u043D\u0438\u0446\u0435. \u0412\u0438\u0434\u0438\u0448\u044C \u0441\u043F\u0440\u0430\u0432\u0430 \u0434\u0432\u0435 \u0441\u043E\u0441\u043D\u044B? \n\u041F\u0440\u043E\u0439\u0434\u0438 \u043C\u0435\u0436\u0434\u0443 \u043D\u0438\u043C\u0438 35 \u0448\u0430\u0433\u043E\u0432 \u043F\u043E \u0442\u0440\u043E\u043F\u0438\u043D\u043A\u0435, \u043F\u043E\u043A\u0430 \u043D\u0435 \u0443\u0432\u0438\u0434\u0438\u0448\u044C \u0431\u0443\u043B\u044B\u0436\u043D\u0438\u043A, \u043F\u0440\u0438\u0434\u0430\u0432\u0438\u0432\u0448\u0438\u0439 \u0441\u043E\u0441\u043D\u0443. \n\u0422\u0435\u043F\u0435\u0440\u044C \u043E\u0433\u043B\u044F\u043D\u0438\u0441\u044C \u0438 \u0438\u0434\u0438 \u043F\u043E \u043D\u0430\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044E \u043A \u0442\u043E\u0440\u043F\u0435\u0434\u0435 20 \u0448\u0430\u0433\u043E\u0432 \u2013 \u043E\u043A\u0430\u0436\u0435\u0448\u044C\u0441\u044F \u043D\u0430 \u0442\u0440\u043E\u043F\u0438\u043D\u043A\u0435. \n\u0421\u043B\u0435\u0434\u0443\u0439 \u043C\u0438\u043C\u043E \u0442\u043E\u0440\u043F\u0435\u0434\u044B, \u043F\u043E\u043A\u0430 \u043D\u0435 \u0443\u0432\u0438\u0434\u0438\u0448\u044C \u0434\u0432\u0435 \u0441\u043A\u0430\u043C\u0435\u0439\u043A\u0438. \n\u0412\u0441\u0442\u0430\u043D\u044C \u043C\u0435\u0436\u0434\u0443 \u043D\u0438\u043C\u0438 \u0438 \u043F\u043E\u0441\u043C\u043E\u0442\u0440\u0438 \u043D\u0430 \u0432\u043E\u0441\u0442\u043E\u043A: \u0442\u0435\u0431\u0435 \u043A \u0441\u0430\u043C\u043E\u0439 \u0434\u0430\u043B\u044C\u043D\u0435\u0439 \u0433\u0440\u0443\u043F\u043F\u0435 \u043A\u0430\u043C\u043D\u0435\u0439. \n\u0418\u0434\u0451\u0448\u044C \u0432\u0435\u0440\u043D\u043E, \u0435\u0441\u043B\u0438 \u0432\u0438\u0434\u0438\u0448\u044C \u0446\u0432\u0435\u0442\u043D\u044B\u0435 \u0431\u0440\u044B\u0437\u0433\u0438. \u041D\u0430 \u043F\u0435\u0440\u0435\u043A\u0440\u0435\u0441\u0442\u043A\u0435 \u0441\u0442\u043E\u0438\u0442 \u043E\u0434\u0438\u043D\u043E\u043A\u0430\u044F \u0441\u043E\u0441\u043D\u0430. \n\u041E\u0442 \u044D\u0442\u043E\u0439 \u0441\u043E\u0441\u043D\u044B \u043F\u043E \u0442\u0440\u043E\u043F\u0438\u043D\u043A\u0435 100 \u0448\u0430\u0433\u043E\u0432 \u043D\u0430 \u0441\u0435\u0432\u0435\u0440, \u0430 \u043F\u043E\u0442\u043E\u043C \u043F\u043E\u043B\u043E\u0432\u0438\u043D\u0443 \u043E\u0442 \u044D\u0442\u043E\u0433\u043E \u043D\u0430 \u0432\u043E\u0441\u0442\u043E\u043A. \n\u041A\u043E\u0433\u0434\u0430 \u044F \u0442\u0430\u043C \u0448\u0451\u043B \u2013 \u0440\u0435\u0431\u044F\u0442\u0430 \u0436\u0430\u0440\u0438\u043B\u0438 \u0448\u0430\u0448\u043B\u044B\u043A\u0438. \n\u0414\u0430\u043B\u044C\u0448\u0435 \u0432\u044B\u0431\u0435\u0440\u0438 \u043B\u0435\u0432\u0443\u044E \u0434\u043E\u0440\u043E\u0433\u0443 \u0438 \u0442\u043E\u043F\u0430\u0439 \u043F\u043E \u043D\u0435\u0439 400 \u0448\u0430\u0433\u043E\u0432, \u043F\u043E\u043A\u0430 \u043D\u0435 \u0443\u0432\u0438\u0434\u0438\u0448\u044C \u0441\u043F\u0440\u0430\u0432\u0430 \u0432\u0442\u043E\u0440\u043E\u0439 \u0441\u0432\u043E\u0440\u043E\u0442\u043E\u043A \u2013 \u0432 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u0438\u0445 \u0448\u0430\u0433\u0430\u0445 \u043E\u0442 \u043D\u0435\u0433\u043E \u0442\u043E\u0447\u043D\u043E \u0432\u0438\u0434\u0435\u043B \u043F\u043E\u043C\u0435\u0447\u0435\u043D\u043D\u0443\u044E \u0431\u0435\u043B\u044B\u043C \u0441\u043E\u0441\u043D\u0443. \n\u0423\u0436\u0435 \u043F\u043E\u0447\u0442\u0438 \u043F\u0440\u0438\u0448\u043B\u0438: 65 \u0448\u0430\u0433\u043E\u0432 \u0432\u0432\u0435\u0440\u0445 \u0438 \u0443\u0432\u0438\u0434\u0438\u0448\u044C \u0442\u043E, \u0440\u0430\u0434\u0438 \u0447\u0435\u0433\u043E \u0441\u044E\u0434\u0430 \u043F\u0451\u0440\u043B\u0438\u0441\u044C. \n\u0421\u043A\u043E\u043B\u044C\u043A\u043E \u0432 \u044D\u0442\u043E\u043C \u0441\u0442\u0440\u043E\u0435\u043D\u0438\u0438 \u043A\u0440\u0443\u0433\u043B\u044B\u0445 \u043E\u043A\u043E\u043D?\n<br>\n<br>\n2 \u0431\u0430\u043B\u043B\u0430\n            ",
            "\n\u041D\u0430 \u043A\u0430\u043A\u043E\u043C \u0436\u0438\u0432\u043E\u0442\u043D\u043E\u043C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0451\u043D \u043F\u0430\u0446\u0438\u0444\u0438\u0441\u0442\u0441\u043A\u0438\u0439 \u0437\u043D\u0430\u0447\u043E\u043A?\n<br>\n<img style='height: auto;width: auto; max-width: 250px;max-height: 250px;' src='/statics/clocks.jpg'/>\n<br>\n<a style=\"text-decoration:underline !important\" href=\"https://pp.vk.me/c636221/v636221285/753/RcWhArFApUM.jpg\">High resolution link</a>\n<br>\n1 \u0431\u0430\u043B\u043B\n\n            ",
            {
                type: 1 /* UPLOAD */, text: "\n\u0417\u0434\u0435\u0441\u044C \u043A\u0440\u0430\u0441\u043D\u043E\u0430\u0440\u043C\u0435\u0439\u0446\u044B \u043C\u043E\u0433\u043B\u0438 \u0431\u044B \u043F\u0440\u043E\u0433\u0443\u043B\u0438\u0432\u0430\u0442\u044C\u0441\u044F \u043F\u0435\u0448\u043A\u043E\u043C. \u041F\u0435\u0448\u043A\u043E\u043C, \u041A\u0430\u0440\u043B! \u041C\u043E\u0436\u0435\u0442 \u0434\u0430\u0436\u0435 \u0424\u0440\u0438\u0434\u0440\u0438\u0445\u0430 \u0431\u044B \u0432\u0441\u0442\u0440\u0435\u0442\u0438\u043B\u0438. \n\u041F\u0440\u0438\u043D\u0435\u0441\u0438\u0442\u0435 \u0444\u043E\u0442\u043E \u043C\u0430\u0442\u0430 \u0431\u0435\u0437 \u0441\u043B\u043E\u0432 \u043D\u0430 \u0434\u043E\u0441\u043A\u0435 \u0438\u0437 \u044D\u0442\u043E\u0433\u043E \u043C\u0435\u0441\u0442\u0430. \n<br>\n<br>\n1 \u0431\u0430\u043B\u043B\n            "
            },
            "\n\n1,0 7,0 <br>\n1,0 2,0 <br>\n4,0 2,0 <br>\n4,0 7,0 <br>\n5,0 1,2 <br>\n5,0 2,0 <br>\n7,0 2,0 <br>\n7,0 7,0 <br>\n10,0 7,0 <br>\n10,0 2,0 <br>\n12,0 2,0 <br>\n12,0 7,0 <br>\n12,0 4,5 <br>\n15,0 7,0 <br>\n12,0 4,5 <br>\n15,0 2,0 <br>\n16,5 5,0 <br>\n16,5 2,0 <br>\n18,0 3,5 <br>\n19,5 5,0 <br>\n19,5 2,0 <br>\n21,0 7,0 <br>\n21,0 2,0 <br>\n24,0 2,0 <br>\n24,0 7,0 <br>\n21,0 7,0 <br>\n<br>\n\u0412\u0430\u043C \u043D\u0443\u0436\u043D\u0430 \u0446\u0435\u043D\u0442\u0440\u0430\u043B\u044C\u043D\u0430\u044F \u0443\u043B\u0438\u0446\u0430. \u041D\u0430\u0437\u043E\u0432\u0438\u0442\u0435 \u0441\u043E\u0441\u0435\u0434\u0435\u0439 \u0442\u043E\u0433\u043E, \u0447\u0435\u0439 \u0442\u0440\u0443\u0434 \u0431\u0435\u0441\u043F\u043E\u043B\u0435\u0437\u0435\u043D. \n<br>\n<br>\n2 \u0431\u0430\u043B\u043B\u0430\n\n            ",
            {
                type: 1 /* UPLOAD */,
                text: "\u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0444\u043E\u0442\u043E \u0432\u0441\u0435\u0439 \u043A\u043E\u043C\u0430\u043D\u0434\u043E\u0439 \u0441 \u0442\u0435\u043A\u0443\u0449\u0438\u043C \u043D\u043E\u043C\u0435\u0440\u043E\u043C \u0414\u041C\u041C, \u0440\u0430\u0441\u043F\u043E\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u043C \u043D\u0430 \u043E\u0431\u044A\u0435\u043A\u0442\u0435 \u0433\u043E\u0440\u043E\u0434\u0441\u043A\u043E\u0439 \u0438\u043D\u0444\u0440\u0430\u0441\u0442\u0440\u043A\u0442\u0443\u0440\u044B (\u0434\u043E\u043C\u0430, \u0431\u0438\u043B\u0431\u043E\u0440\u0434\u044B...).. <br><br> 0,5 \u0431\u0430\u043B\u043B\u0430"
            },
            {
                type: 2 /* UPLOAD_5 */,
                text: "\u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0444\u043E\u0442\u043E \u0441 \u0447\u0438\u0441\u043B\u0430\u043C\u0438 \u0438\u0437 \u043F\u043E\u0441\u043B\u0435\u0434\u043E\u0432\u0430\u0442\u0435\u043B\u044C\u043D\u043E\u0441\u0442\u0438 A000055 oeis \u0431\u043E\u043B\u044C\u0448\u0435 40 \u043D\u0430 \u0433\u043E\u0440\u043E\u0434\u0441\u043A\u0438\u0445 \u043E\u0431\u044A\u0435\u043A\u0442\u0430\u0445. \u041E\u0434\u043D\u043E \u0447\u0438\u0441\u043B\u043E \u0434\u043E\u043B\u0436\u043D\u043E \u0432\u0441\u0442\u0440\u0435\u0447\u0430\u0442\u044C\u0441\u044F \u043D\u0435 \u0447\u0430\u0449\u0435 \u043E\u0434\u043D\u043E\u0433\u043E \u0440\u0430\u0437\u0430.<br><br> \u0417\u0430 \u043E\u0434\u043D\u043E \u0444\u043E\u0442\u043E 0,2 \u0431\u0430\u043B\u043B\u0430, \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 5 \u0444\u043E\u0442\u043E\u0433\u0440\u0430\u0444\u0438\u0439"
            },
            "\u041F\u0435\u0440\u0435\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u043F\u0435\u0441\u043D\u044E \u042D\u043A\u0441\u043F\u043E\u043D\u0430\u0442 \u043D\u0430 \u043C\u0430\u0442\u0435\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043B\u0430\u0434 (\u043A\u0443\u043F\u043B\u0435\u0442+\u043F\u0440\u0438\u043F\u0435\u0432), \u0437\u0430\u043F\u0438\u0448\u0438\u0442\u0435 \u043D\u0430 \u0432\u0438\u0434\u0435\u043E \u0438 \u043F\u0440\u0438\u0448\u043B\u0438\u0442\u0435 \u043D\u0430\u043C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0443/\u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u0432\u0438\u0434\u0435\u043E. <br><br> \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 2 \u0431\u0430\u043B\u043B\u0430 \u043D\u0430 \u0443\u0441\u043C\u043E\u0442\u0440\u0435\u043D\u0438\u0435 \u0436\u044E\u0440\u0438",
            {
                type: 2 /* UPLOAD_5 */,
                text: "\u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0444\u043E\u0442\u043E \u0441 \u043B\u044E\u0431\u043E\u0439 \u043D\u0430\u0434\u043F\u0438\u0441\u044C\u044E \u0438\u043B\u0438 \u043E\u0431\u044A\u0435\u043A\u0442\u043E\u043C, \u0438\u043C\u0435\u044E\u0449\u0438\u043C \u043E\u0442\u043D\u043E\u0448\u0435\u043D\u0438\u0435 \u043A \u0430\u043B\u0433\u0435\u0431\u0440\u0435 \u0438\u043B\u0438 \u043C\u0430\u0442\u0430\u043D\u0430\u043B\u0438\u0437\u0443. \u041D\u0435 \u0431\u043E\u043B\u044C\u0448\u0435 \u043E\u0434\u043D\u043E\u0433\u043E \u043E\u0434\u0438\u043D\u0430\u043A\u043E\u0432\u043E\u0433\u043E \u043E\u0431\u044A\u0435\u043A\u0442\u0430. <br><br>\u0417\u0430 \u043E\u0434\u043D\u043E \u0444\u043E\u0442\u043E 0,1 \u0431\u0430\u043B\u043B\u0430, \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 5 \u0444\u043E\u0442\u043E\u0433\u0440\u0430\u0444\u0438\u0439"
            },
            "\u0421\u043D\u0438\u043C\u0438\u0442\u0435 \u0440\u0435\u043A\u043B\u0430\u043C\u0443 \u0432\u0430\u0448\u0435\u0433\u043E \u043B\u044E\u0431\u0438\u043C\u043E\u0433\u043E \u0443\u0447\u0435\u0431\u043D\u043E\u0433\u043E \u043A\u0443\u0440\u0441\u0430 \u043D\u0430 \u043C\u0430\u0442\u043C\u0435\u0445\u0435 \u0438 \u043F\u0440\u0438\u0448\u043B\u0438\u0442\u0435 \u043D\u0430\u043C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0443/\u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u0432\u0438\u0434\u0435\u043E. <br><br> \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 1 \u0431\u0430\u043B\u043B \u043D\u0430 \u0443\u0441\u043C\u043E\u0442\u0440\u0435\u043D\u0438\u0435 \u0436\u044E\u0440\u0438",
            "\u041F\u0435\u0442\u0435\u043D\u044C\u043A\u0430 \u043E\u0447\u0435\u043D\u044C \u043B\u044E\u0431\u0438\u0442 \u0448\u0430\u0443\u0440\u043C\u0443. \u041D\u043E \u043D\u0435 \u0430 \u0431\u044B \u043A\u0430\u043A\u0443\u044E! \u0412\u043E\u0437\u043B\u0435 \u043A\u0438\u0440\u043E\u0432\u0441\u043A\u043E\u0433\u043E \u043F\u043E \u0423\u0441\u043F\u0435\u043D\u0441\u043A\u043E\u043C\u0443 \u043F\u0440\u043E\u0441\u043F\u0435\u043A\u0442\u0443 127 \u043C\u043E\u0436\u043D\u043E \u0440\u0430\u0437\u0434\u043E\u0431\u044B\u0442\u044C \u0442\u0443 \u0441\u0430\u043C\u0443\u044E. \u041F\u0440\u0438\u0432\u0435\u0437\u0438\u0442\u0435 \u0435\u0435 \u043D\u0430 \u043D\u0430\u0431\u0435\u0440\u0435\u0436\u043D\u0443\u044E \u0440\u0430\u0431\u043E\u0447\u0435\u0439 \u043C\u043E\u043B\u043E\u0434\u0435\u0436\u0438 \u043A\u0443\u0434\u0430-\u0442\u043E \u043C\u0435\u0436\u0434\u0443 \u0434\u043E\u043C\u0430\u043C\u0438 1 \u0438 3. \u0411\u0435\u043B\u044B\u0439 \u0444\u043E\u043B\u044C\u043A\u0441\u0432\u0430\u0433\u0435\u043D 898. 2 \u0431\u0430\u043B\u043B\u0430"
        ]
    }
};
var redis = require("redis");
var portArg = process.env.REDIS_URL;
var client = portArg ? redis.createClient(portArg) : redis.createClient();
client.on("error", function (err) {
    log('Error start redis listener');
});
log('Start redis client');
var TEAMS_KEY = "teams";
var APP_STATE_KEY = "app_state";
var TEAMS_CACHE = [];
var initTeams = function () {
    var multi = client.multi();
    multi.hgetall(TEAMS_KEY, function (err, object) {
        var count = 0;
        for (var l in object) {
            if (object.hasOwnProperty(l)) {
                var value = object[l];
                var items = JSON.parse(value);
                if (items.firstLoginDate) {
                    var firstLoginDate = items.firstLoginDate;
                    var endDate = items.endQuestDate;
                    //fix date after serialization
                    items.firstLoginDate = new Date(firstLoginDate);
                    items.endQuestDate = new Date(endDate);
                }
                log('Load team ' + (count++) + ": " + items.name + ' token: ' + items.tokenId);
                TEAMS_CACHE.push(items);
            }
        }
    });
    multi.hgetall(APP_STATE_KEY, function (err, object) {
        if (!object) {
            log('ERROR! No states');
        }
        var count = 0;
        for (var l in object) {
            if (object.hasOwnProperty(l)) {
                var value = object[l];
                stageManager.states[l] = JSON.parse(value);
                log('Load state for team ' + (count++) + ': with token ' + l);
            }
        }
    });
    multi.exec(function () {
        initServer();
    });
};
client.exists(TEAMS_KEY, function (err, reply) {
    log('Database ' + reply ? "initialized" : "empty");
    var defaultTeams = getDefaultTeams();
    var toPush = {};
    var multi = client.multi();
    for (var _i = 0, defaultTeams_1 = defaultTeams; _i < defaultTeams_1.length; _i++) {
        var team = defaultTeams_1[_i];
        multi.hset(TEAMS_KEY, team.tokenId, JSON.stringify(team));
        multi.hset(APP_STATE_KEY, team.tokenId, JSON.stringify(initDefaultStateObject(team)));
        if (!reply) {
            TEAMS_CACHE.push(team);
        }
        log('Update or store default team: ' + team.name + ' token: ' + team.secretCode);
    }
    multi.exec(function () {
        if (reply) {
            initTeams();
        }
        else {
            initServer();
        }
    });
});
function getDefaultTeams() {
    var teams = [];
    teams.push({
        name: "Тестовая админская команда",
        secretCode: "test+test-",
        tokenId: "test+test-",
        admin: true,
        startFromStage: 0
    });
    return teams;
}
function initDefaultStateObject(team) {
    var stages = [];
    var appState = {
        bonus: null,
        stages: stages
    };
    var defaultStages = defaultData.stages;
    var startFromStage = team.startFromStage;
    var pushNumber = 0;
    for (var i = startFromStage; i < defaultStages.length; i++) {
        var status = i == startFromStage ? 1 /* OPEN */ : 0 /* LOCKED */;
        stages.push({
            id: String(i),
            status: status,
            showNumber: pushNumber++
        });
    }
    for (var i = 0; i < startFromStage; i++) {
        var item = {
            id: String(i),
            status: 0 /* LOCKED */,
            showNumber: pushNumber++
        };
        stages.push(item);
    }
    stages[stages.length - 1].last = true;
    appState.bonus = {
        id: "bonus",
        status: 3 /* BONUS */,
        showNumber: pushNumber++
    };
    stageManager.states[team.tokenId] = appState;
    return appState;
}
function log(message) {
    console.log('DMM QUEST: ' + message);
}
var AWS_ACCESS_KEY = process.env.AWS_ACCESS_KEY || "YOUR_AWS_KEY";
var AWS_SECRET_KEY = process.env.AWS_SECRET_KEY || "YOUR_AWS_SECRET_KEY";
var S3_BUCKET = process.env.S3_BUCKET || "dmmquest";
var aws = require('aws-sdk');
function processGetAWS(request, callback) {
    aws.config.update({
        accessKeyId: AWS_ACCESS_KEY,
        secretAccessKey: AWS_SECRET_KEY,
        signatureVersion: 'v4',
        region: 'eu-central-1'
    });
    var s3 = new aws.S3();
    var url = request.token + '/stage_' + request.stageId + '/quest_' + request.questId + '/f' + new Date().getTime() + '_' + request.fileName;
    var s3_params = {
        Bucket: S3_BUCKET,
        Key: url,
        Expires: 60,
        ContentType: request.fileType,
        ACL: 'public-read'
    };
    s3.getSignedUrl('putObject', s3_params, function (err, data) {
        var result;
        if (err) {
            result = {
                success: false
            };
        }
        else {
            result = {
                sign: data,
                url: 'https://' + S3_BUCKET + '.s3.amazonaws.com/' + url,
                success: true
            };
        }
        callback(result);
    });
}
function getDefaultData() {
    if (all_text) {
        return all_text;
    }
    return {
        stages: [
            {
                name: "О полевых растениях",
                quests: [
                    "Это зеленое и растет на грядке в огороде у дедушки федора.",
                    "Это синее и не растет на грядке в огороде у дедушки федора.",
                    "Этоне растет вообще нигде, но может вас убить"
                ]
            },
            {
                name: "О козлах отпущения",
                quests: [
                    "Козлы это животные. Назовите еще хоть одно животное.",
                    "Жирафы не козлы. Докажите это утверждение в трех словах",
                    "Путь самурая непрост. А каков путь козла-самурая?"
                ]
            },
            {
                name: "О программистах",
                quests: [
                    "Как вы попали в сферу разработки ПО?",
                    "Какой был ваш первый язык программирования?",
                    "Сколько примерно будет 2^32?",
                    "Как сравнить две переменные типа double или float на равенство?",
                    "Что такое класс? Что такое объект? В чем разница?",
                    "Что такое член класса? Чем он отличается от других?",
                ]
            }
        ],
        bonus: {
            name: "О программистах",
            quests: [
                "Клонируйте овечку долли и докажите, что это ее копия",
                "Сколько попугает в жирафе? А есть он ходит по диагонали?",
                "Убейте какое-нибудь животное и пришлите фотографию"
            ]
        }
    };
}
var defaultData = getDefaultData();
var StageManager = (function () {
    function StageManager() {
        this.states = {};
        this.stagesNames = getStagesNames();
    }
    StageManager.prototype.setAnswers = function (token, stageId, answers, fromClose) {
        var stage = this.getStage(token, stageId);
        if (!stage) {
            return null;
        }
        if (stage.status == 2 /* COMPLETED */ ||
            stage.status == 0 /* LOCKED */) {
            return null;
        }
        for (var _i = 0, answers_1 = answers; _i < answers_1.length; _i++) {
            var answer = answers_1[_i];
            if (!stage.questAnswers) {
                stage.questAnswers = {};
            }
            var oldAnswer = stage.questAnswers[answer.id];
            if (fromClose && oldAnswer && oldAnswer.answer && !answer.answer) {
                continue;
            }
            stage.questAnswers[answer.id] = answer;
        }
        var stagesName = this.stagesNames[stageId];
        log('Updated answers "' + token + '" for stage "' + stagesName + '". Answers: ' + JSON.stringify(answers));
        this.saveAppStateToDB(token, this.getAppState(token), function (err) {
            if (!err) {
                log('Saved new answers "' + token + '" to DB for ' + stagesName);
            }
            else {
                log('ALERT! Erorr save new answers to DB for ' + stagesName);
            }
        });
        return stage;
    };
    StageManager.prototype.getStagesNames = function () {
        return this.stagesNames;
    };
    StageManager.prototype.closeStage = function (token, stageId) {
        var stage = this.getStage(token, stageId);
        if (!stage || stage.status != 1 /* OPEN */) {
            return this.getAppState(token);
        }
        stage.status = 2 /* COMPLETED */;
        stage.closedTime = toEkbString(new Date());
        var appState = this.getAppState(token);
        var nextStage = this.getNextStage(appState, stage);
        if (nextStage && nextStage.status == 0 /* LOCKED */) {
            nextStage.status = 1 /* OPEN */;
        }
        if (stage.last) {
            //close bonus if the stage is last
            appState.bonus.status = 2 /* COMPLETED */;
            appState.bonus.closedTime = toEkbString(new Date());
        }
        var info = this.stagesNames[stageId] + ' team ' + teamManager.findTeamByToken(token).name;
        log('Closed stage token ' + token + ' stage ' + info);
        var appState = this.getAppState(token);
        this.saveAppStateToDB(token, appState, function (err) {
            if (!err) {
                log('Update app state for ' + info);
            }
            else {
                log('ALERT: Error update app state for ' + info);
            }
        });
        return appState;
    };
    StageManager.prototype.getQuestionTexts = function (token, stageId) {
        var appState = this.getAppState(token);
        var stage = getStageById(appState, stageId);
        if (!stage || stage.status == 0 /* LOCKED */) {
            return null;
        }
        if (stage.status == 3 /* BONUS */ ||
            stageId == "bonus") {
            return defaultData.bonus.quests;
        }
        var stageInfo = defaultData.stages[Number(stageId)];
        return stageInfo && stageInfo.quests;
    };
    StageManager.prototype.unlockLastStage = function (tokenId) {
        var _this = this;
        var appState = this.getAppState(tokenId);
        var team = teamManager.findTeamByToken(tokenId);
        if (!team) {
            log('Unlock request for incorrect team ' + team.tokenId);
            return false;
        }
        var lastCompletedStage = null;
        var number = 0;
        var stages = appState.stages;
        for (var _i = 0, stages_1 = stages; _i < stages_1.length; _i++) {
            var stage = stages_1[_i];
            number++;
            if (stage.status == 2 /* COMPLETED */) {
                lastCompletedStage = stage;
            }
        }
        if (lastCompletedStage == null) {
            return false;
        }
        lastCompletedStage.status = 1 /* OPEN */;
        log('Unlocked stage ' + this.stagesNames[lastCompletedStage.id] + ' for ' + tokenId);
        delete lastCompletedStage.closedTime;
        if (number == stages.length &&
            appState.bonus.status == 2 /* COMPLETED */) {
            appState.bonus.status = 3 /* BONUS */;
            delete lastCompletedStage.closedTime;
            log('Unlocked bonus for ' + tokenId);
        }
        this.saveAppStateToDB(team.tokenId, appState, function (err) {
            if (!err) {
                log('Update unlock stage for ' + team.tokenId + "  stage " + _this.stagesNames[lastCompletedStage.id]);
            }
            else {
                log('ALERT: Error update unlock stage for ' + team.tokenId);
            }
        });
        return true;
    };
    StageManager.prototype.getNextStage = function (appState, stage) {
        if (stage.status == 3 /* BONUS */) {
            return null;
        }
        var showNumber = stage.showNumber;
        var nextStage = appState.stages[showNumber + 1];
        if (!nextStage) {
            return null;
        }
        return nextStage;
    };
    StageManager.prototype.getStage = function (token, stageId) {
        var appState = this.getAppState(token);
        if (!appState) {
            return null;
        }
        return getStageById(appState, stageId);
    };
    StageManager.prototype.getAppState = function (token) {
        var state = this.states[token];
        if (state) {
            return state;
        }
        return this.createAppState(token);
    };
    StageManager.prototype.createAppState = function (token) {
        log('Init state:' + token);
        var team = teamManager.findTeamByToken(token);
        if (!team) {
            return;
        }
        return initDefaultStateObject(team);
    };
    StageManager.prototype.saveAppStateToDB = function (token, state, callback) {
        client.hset(APP_STATE_KEY, token, JSON.stringify(state), callback);
    };
    return StageManager;
}());
function getStageById(state, stageId) {
    if (!state) {
        return null;
    }
    for (var _i = 0, _a = state.stages; _i < _a.length; _i++) {
        var stage = _a[_i];
        if (stage.id == stageId) {
            return stage;
        }
    }
    if (stageId == 'bonus') {
        return state.bonus;
    }
    return null;
}
function getStagesNames() {
    var result = {};
    var stages = defaultData.stages;
    for (var i = 0; i < stages.length; i++) {
        var rawStage = stages[i];
        result[String(i)] = rawStage.name;
    }
    result['bonus'] = defaultData.bonus.name;
    return result;
}
var stageManager = new StageManager();
var minimist = require('minimist');
var express = require('express');
var serveStatic = require('serve-static');
var bodyParser = require('body-parser');
var path = require('path');
var moment = require('moment-timezone');
var PORT = process.env.PORT || 8080;
var TARGET_PATH_MAPPING = {
    BUILD: './build',
    DIST: './dist'
};
var TARGET = minimist(process.argv.slice(2)).TARGET || 'BUILD';
function initServer() {
    log('Start creating server');
    var server = express();
    server.use(bodyParser.json());
    server.use(bodyParser.urlencoded({
        extended: true
    }));
    server
        .use(serveStatic(TARGET_PATH_MAPPING[TARGET]))
        .use('/statics', express.static(__dirname + '/statics'))
        .listen(PORT);
    server.post('/quest-texts', function (req, res, next) {
        var request = req.body;
        res.json(processQuestTextsRequest(request));
    });
    server.post('/state', function (req, res, next) {
        var request = req.body;
        res.json(processStateRequest(request));
    });
    server.post('/login', function (req, res, next) {
        var request = req.body;
        if (!request.secretCode) {
            res.json({
                authenticated: false
            });
            return;
        }
        res.json(processLoginRequest(request));
    });
    server.post('/save', function (req, res, next) {
        var request = req.body;
        res.json(processAnswerUpdateRequest(request, false));
    });
    //
    server.post('/complete', function (req, res, next) {
        var request = req.body;
        var token = request.token;
        var options = processAnswerUpdateRequest(request, true);
        if (!options.success) {
            res.json({
                success: false
            });
            return;
        }
        var result = stageManager.closeStage(token, request.stageId);
        var response = {
            res: result,
            success: true
        };
        res.json(response);
    });
    server.get('/stage/*', function (req, res, next) {
        res.sendFile(path.join(__dirname, TARGET, '/index.html'));
    });
    server.get('/stages', function (req, res, next) {
        res.sendFile(path.join(__dirname, TARGET, '/index.html'));
    });
    server.post('/teams', function (req, res, next) {
        var request = req.body;
        res.json(processGetTeamsRequest(request));
    });
    server.post('/remove-team', function (req, res, next) {
        var request = req.body;
        res.json(processRemoveTeamRequest(request));
    });
    server.post('/add-team', function (req, res, next) {
        var request = req.body;
        res.json(processAddTeamRequest(request));
    });
    server.post('/rest-time', function (req, res, next) {
        var request = req.body;
        res.json(getRestTime(request));
    });
    server.post('/unlock-stage', function (req, res, next) {
        var request = req.body;
        var team = checkToken(request.token);
        if (!team || !team.admin) {
            res.json({
                success: false
            });
        }
        res.json({
            success: stageManager.unlockLastStage(request.teamTokenId)
        });
    });
    server.post('/sign_s3', function (req, response, next) {
        var request = req.body;
        var team = checkToken(request.token);
        if (!team) {
            return;
        }
        processGetAWS(request, function (result) {
            console.log('aws req: ' + JSON.stringify(result));
            response.json(result);
        });
    });
    log('Created server for: ' + TARGET + ', listening on port ' + PORT);
}
function processStateRequest(req) {
    var token = req.token;
    var team = checkToken(token);
    if (!team) {
        log('Internal error. No team for token ' + token);
        return { success: false };
    }
    return {
        success: true,
        state: {
            appState: stageManager.getAppState(token),
            stagesNames: stageManager.getStagesNames()
        }
    };
}
function processAnswerUpdateRequest(req, fromClose) {
    var token = req.token;
    var team = checkToken(token);
    if (!team) {
        return { success: false };
    }
    if (!checkTime(team)) {
        log('Try to save answers "' + token + '" after complete ' + JSON.stringify(req.answers));
        return { success: false };
    }
    var answers = stageManager.setAnswers(token, req.stageId, req.answers, fromClose);
    return {
        success: !!answers,
        stage: answers
    };
}
function processLoginRequest(req) {
    return teamManager.login(req.secretCode);
}
function processQuestTextsRequest(request) {
    var token = request.token;
    var team = checkToken(token);
    if (!team) {
        return { success: false };
    }
    var questTexts = stageManager.getQuestionTexts(token, request.stageId);
    if (!questTexts) {
        return {
            success: false
        };
    }
    return {
        success: true,
        questTexts: {
            stageId: request.stageId,
            quests: questTexts.map(function (el, i) {
                var text;
                var type;
                if (typeof el === "string") {
                    text = el;
                }
                else {
                    text = el.text;
                    type = el.type;
                }
                var result = {
                    id: i,
                    text: text
                };
                if (type) {
                    result.type = type;
                }
                return result;
            })
        }
    };
}
function processRemoveTeamRequest(request) {
    var token = request.token;
    var team = checkToken(token);
    if (!team || !team.admin) {
        return {
            success: false
        };
    }
    var result = teamManager.removeTeam(request.teamTokenId);
    return {
        success: result
    };
}
function processGetTeamsRequest(request) {
    var token = request.token;
    var team = checkToken(token);
    if (!team || !team.admin) {
        return {
            success: false
        };
    }
    var result = [];
    for (var _i = 0, TEAMS_CACHE_1 = TEAMS_CACHE; _i < TEAMS_CACHE_1.length; _i++) {
        var cur = TEAMS_CACHE_1[_i];
        var teamSimple = {
            admin: cur.admin,
            name: cur.name,
            secretCode: cur.secretCode,
            startFromStage: cur.startFromStage,
            tokenId: cur.tokenId
        };
        var info = {
            team: cur,
            appState: stageManager.getAppState(cur.tokenId)
        };
        if (cur.firstLoginDate) {
            info.firstLoginDateEkbTimezone = toEkbString(cur.firstLoginDate);
            info.endQuestEkbTimezone = toEkbString(cur.endQuestDate);
        }
        result.push(info);
    }
    return {
        success: true,
        teams: result
    };
}
function processAddTeamRequest(request) {
    var team = teamManager.findTeamByToken(request.token);
    if (!team || !team.admin) {
        return {
            success: false
        };
    }
    var newTeam = teamManager.createTeam(request.teamName);
    return { success: !!newTeam };
}
function checkToken(token) {
    return teamManager.findTeamByCode(token);
}
function toEkbString(date) {
    return moment(date).tz('Asia/Yekaterinburg').format("YYYY-MM-DD HH:mm");
}
function getRestTime(request) {
    var token = request.token;
    var team = checkToken(token);
    if (!team) {
        return {
            success: false
        };
    }
    if (!team.endQuestDate) {
        return {
            restTimeInSeconds: "-1",
            success: true
        };
    }
    var result = diffWithCurrentTime(team);
    return {
        success: true,
        restTimeInSeconds: String(result),
        isCompleted: result <= 0
    };
}
function checkTime(team) {
    if (!team.endQuestDate) {
        return true;
    }
    return diffWithCurrentTime(team) > 0;
}
function diffWithCurrentTime(team) {
    var currentTime = moment();
    var endTime = moment(team.endQuestDate);
    return endTime.diff(currentTime, 'seconds');
}
var COUNT_HOURS_TO_SOLVE = 7;
var TeamManager = (function () {
    function TeamManager() {
    }
    TeamManager.prototype.findTeamByCode = function (secretCode) {
        if (!secretCode) {
            return null;
        }
        for (var _i = 0, TEAMS_CACHE_2 = TEAMS_CACHE; _i < TEAMS_CACHE_2.length; _i++) {
            var team = TEAMS_CACHE_2[_i];
            if (team.secretCode.toLocaleLowerCase() == secretCode.toLocaleLowerCase()) {
                return team;
            }
        }
        return null;
    };
    TeamManager.prototype.findTeamByToken = function (tokenId) {
        for (var _i = 0, TEAMS_CACHE_3 = TEAMS_CACHE; _i < TEAMS_CACHE_3.length; _i++) {
            var team = TEAMS_CACHE_3[_i];
            if (team.tokenId == tokenId) {
                return team;
            }
        }
        return null;
    };
    TeamManager.prototype.removeTeam = function (tokenId) {
        var team = this.findTeamByToken(tokenId);
        if (!team) {
            return false;
        }
        var index = TEAMS_CACHE.indexOf(team);
        if (index == -1) {
            return false;
        }
        TEAMS_CACHE.splice(index, 1);
        delete stageManager.states[tokenId];
        log('ALERT: Removed team from app ' + team.name + " token: " + team.tokenId);
        var multi = client.multi();
        multi.hdel(TEAMS_KEY, team.tokenId);
        multi.hdel(APP_STATE_KEY, team.tokenId);
        multi.exec(function () {
            log('ALERT: Removed team and state from database ' + team.name);
        });
        return true;
    };
    TeamManager.prototype.createTeam = function (name) {
        var secretCode = TeamManager.makeid();
        var newStartFrom = this.getNextStartFromStage();
        var team = {
            name: name,
            secretCode: secretCode,
            tokenId: secretCode,
            startFromStage: newStartFrom
        };
        TEAMS_CACHE.push(team);
        var token = team.tokenId;
        log('Added team to app: ' + team.name + ' ' + team.secretCode);
        this.saveTeamToDB(team, function () {
            log('Saved team to database: ' + team.name);
        });
        stageManager.saveAppStateToDB(token, (stageManager.getAppState(token)), function () {
            log('Saved state to database: ' + team.name);
        });
        return team;
    };
    TeamManager.prototype.listTeams = function () {
        return TEAMS_CACHE;
    };
    TeamManager.prototype.login = function (secretCode) {
        var team = this.findTeamByCode(secretCode);
        if (team) {
            if (!team.firstLoginDate && !team.admin) {
                var date = new Date();
                var endDate = new Date(); //new object!
                endDate.setTime(date.getTime() + (COUNT_HOURS_TO_SOLVE * 60 * 60 * 1000));
                team.endQuestDate = endDate;
                team.firstLoginDate = date;
                log('First login for team: ' + team.name + ' token ' + team.tokenId + ' time: ' + toEkbString(team.firstLoginDate));
                this.saveTeamToDB(team);
            }
            return {
                authenticated: true,
                name: team.name,
                token: team.tokenId,
                admin: team.admin
            };
        }
        log('Incorrect login secret code access "' + secretCode + '"');
        return { authenticated: false };
    };
    TeamManager.prototype.getNextStartFromStage = function () {
        var lastTeam = TEAMS_CACHE[TEAMS_CACHE.length - 1];
        var startFromStage = lastTeam.startFromStage;
        var nextStage = startFromStage + 1;
        if (nextStage < defaultData.stages.length) {
            return nextStage;
        }
        return 0;
    };
    TeamManager.prototype.saveTeamToDB = function (team, callback) {
        client.hset(TEAMS_KEY, team.tokenId, JSON.stringify(team), callback);
    };
    TeamManager.makeid = function () {
        var text = "";
        var possible = "abcdefghijklmnopqrstuvwxyz0123456789";
        for (var i = 0; i < 8; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
    };
    return TeamManager;
}());
var teamManager = new TeamManager();
//# sourceMappingURL=server.js.map