var all_text = {
    stages: [
        {
            name: "Этап «Мост Макарова»",
            quests: [
                "\u0411\u0443\u0440\u044F \u043C\u0433\u043B\u043E\u044E \u043D\u0435\u0431\u043E \u043A\u0440\u043E\u0435\u0442 \n\u0412\u0438\u0445\u0440\u0438 \u0441\u043D\u0435\u0436\u043D\u044B\u0435 \u043A\u0440\u0443\u0442\u044F\n\u0414\u0432\u0438\u0433\u0430\u0439\u0442\u0435 \u0441\u0432\u043E\u0435\u0439 \u0442\u043E\u043B\u043F\u043E\u044E\n\u041E\u0442 \u0420\u0435\u043F\u0435\u0440\u0430 \u0434\u043E \u041C\u0435\u043D\u044F.\n\u0413\u0434\u0435 \u043F\u043E\u0434 \u043A\u0440\u043E\u0432\u043B\u0435\u0439 \u043E\u0431\u0432\u0435\u0442\u0448\u0430\u043B\u043E\u0439 \n\u0414\u0440\u0435\u0432\u043E \u0447\u0443\u0434\u043D\u043E\u0435 \u0441\u0442\u043E\u0438\u0442,\n\u0428\u0430\u0445\u043C\u0430\u0442\u0438\u0441\u0442 \u2013 \u0441\u043F\u043E\u0440\u0442\u0441\u043C\u0435\u043D \u0431\u044B\u0432\u0430\u043B\u044B\u0439\n\u0422\u0430\u043C \u043F\u0440\u043E\u0432\u043E\u0434\u0438\u0442 \u0441\u0432\u043E\u0439 \u0433\u0430\u043C\u0431\u0438\u0442.\n\u0412\u044B\u043F\u044C\u0435\u043C, \u0434\u043E\u0431\u0440\u0430\u044F \u043F\u043E\u0434\u0440\u0443\u0436\u043A\u0430,\n\u041D\u0443\u0436\u0435\u043D \u043D\u043E\u043C\u0435\u0440 \u0438\u0433\u0440\u043E\u043A\u0430.\n\u0412\u044B\u043F\u044C\u0435\u043C \u0441 \u0433\u043E\u0440\u044F; \u0413\u0434\u0435 \u0436\u0435 \u043A\u0440\u0443\u0436\u043A\u0430?\n\u042F \u0437\u0430 \u043A\u0440\u0443\u0436\u043A\u043E\u0439. \u0412\u0441\u0435\u043C \u043F\u043E\u043A\u0430",
                "\u041F\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u044C\u0442\u0435: exp((-(((x-4)^2+(y-4)^2)^2))/1000)+exp((-(((x+4)^2+(y+4)^2)^2))/1000)+0.15*exp(-(((x+4)^2+(y+4)^2)^2))+0.15*exp(-(((x-4)^2+(y-4)^2)^2)) \n\u041F\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u0438\u043B\u0438? \u0412\u043E\u0437\u044C\u043C\u0438\u0442\u0435 \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u0434\u043D\u0443. \u041F\u043E\u0434\u043E\u0439\u0434\u0438\u0442\u0435 \u0432 \u043F\u043B\u043E\u0442\u043D\u0443\u044E \u043A \u043C\u043E\u0440\u044E. \u0427\u0442\u043E \u0434\u0435\u043B\u0430\u043B \u043D\u0438\u043A\u043D\u0435\u0439\u043C, \u043A\u043E\u0433\u0434\u0430 \u043A\u0442\u043E-\u0442\u043E \u043B\u043E\u0436\u0438\u043B\u0441\u044F \u0441\u043F\u0430\u0442\u044C?",
                "\u042D\u0442\u0430 \u0443\u043B\u0438\u0446\u0430 \u043C\u0435\u043D\u044F\u043B\u0430 \u0441\u0432\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u0440\u0430\u0437. \u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0435\u0435 \u043F\u0435\u0440\u0435\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435 \u043F\u043E\u0437\u0436\u0435 \u0441\u0442\u0430\u043B\u043E \u0441\u0432\u044F\u0437\u0430\u043D\u043E \u0441 \u0423\u0440\u0413\u0423. \u041D\u0430\u0439\u0434\u0438\u0442\u0435 \u0446\u0435\u043D\u0442\u0440 \u0443\u043B\u0438\u0446\u044B. \u041A\u0430\u043A\u043E\u0439 \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 \u043C\u043D\u043E\u0433\u043E\u0433\u0440\u0430\u043D\u043D\u0438\u043A \u043C\u043E\u0436\u043D\u043E \u0432\u043F\u0438\u0441\u0430\u0442\u044C \u0432 \u043E\u0441\u043D\u043E\u0432\u0430\u043D\u0438\u0435 \u043A\u043E\u043D\u0441\u0442\u0440\u0443\u043A\u0446\u0438\u0438 \u0432\u043E\u0437\u043B\u0435?",
                "В конце своих приключений Буратино приобрел его, который обязательно бы подошёл к нему. Крупнейшая в Екатеринбурге выставка их соединяет два музея. Переехавший недавно каменный мужик смотрит на нужный. Какой ползучий гад спрятался на камнях возле?",
                "Аудиофайл. Загадано место. Сколько перьев, торчащих из клетки имеют спираль?",
                "На Набережной Рабочей Молодёжи между домами 1 и 3 стоит белый фольксваген 898, там всю команду ждёт Петенька."
            ]
        },
        {
            name: "Этап «Физра не в Павлике»",
            quests: [
                "Сколько ещё говядины надо добавить, чтобы про них можно было петь песню?<br><img style='height: auto;width: auto; max-width: 250px;max-height: 250px;' src='/statics/letters.png'/>",
                "Опытный программист найдёт это место вслепую (2,5) (2,8) (2,7) (1,9) (2,4) (2,9) (3,7)         (2,7) (3,8) (2,7) (2,6) (2,7) (1,6) (2,2). Идите к зданию полному opium des volkes. Сколько трёхмерных гауссиан перед вами?",
                "\u0417\u0434\u0435\u0441\u044C\n<br>\n<br>\n<img style='height: auto;width: auto; max-width: 200px;max-height: 200px;' src='/statics/sun.png'/>\n<br>\n\u043D\u0430\u0439\u0434\u0438\u0442\u0435 \u0441\u0430\u043C\u0443\u044E \u0432\u044B\u0441\u043E\u043A\u0443\u044E \u043F\u043B\u043E\u0449\u0430\u0434\u043A\u0443.\n\u0421\u0440\u0435\u0434\u0438 \u0438\u0437\u043B\u044E\u0431\u043B\u0435\u043D\u043D\u044B\u0445 \u043F\u0440\u0435\u0434\u043C\u0435\u0442\u043E\u0432 \u0431\u0430\u0431\u0443\u0448\u0435\u043A \u0432\u044B\u0431\u0435\u0440\u0435\u0442\u0435 \u0446\u0435\u043D\u0442\u0440\u0430\u043B\u044C\u043D\u044B\u0439. \u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0444\u043E\u0442\u043E, \u0441\u043B\u0435\u0434\u0443\u044F \u0438\u043D\u0441\u0442\u0440\u0443\u043A\u0446\u0438\u044F\u043C.",
                "На улице папиного уральца найдите салон, сочетающий красоту с орфографией. Следуя указателю ароматного пара, разыщите предмет-очевидность. Назовите аргументы коньюкции?",
                "Самое время подкрепиться! Встаньте напротив места, где это можно сделать сыто и с огоньком. Следуя за тем, чего хотят все проигравшие, скажите, какой расстояние от фасада является безопасным?"
            ]
        },
        {
            name: "Этап «тУПИк»",
            quests: [
                "Много ли есть в Екатеринбурге памятников, которые стоят на \"своих\" улицах? На одной из таких улиц мы загадали дом с чётным номером N. N mod 100 + N div 100 +1 = M, где M - номер средней образовательной школы в этом доме. Сколько свободных рук у памятника перед ним?",
                "Это место находится между тремя улицами. Первая названа в честь первого, вторая связана с первым пятого, третья носит имя первого кавалера Ордена Красного Знамени. С третьей улицы загляните внутрь и ответьте, почему запрещён въезд?",
                "\n\u0412 \u044D\u0442\u043E \u0441\u043B\u043E\u0436\u043D\u043E \u043F\u043E\u0432\u0435\u0440\u0438\u0442\u044C, \u043D\u043E \u0443 \u041F\u0443\u0448\u043A\u0438\u043D\u0430 \u0438 \u0432\u043E\u0442 \u044D\u0442\u0438\u0445 \u0434\u0435\u0432\u0443\u0448\u0435\u043A \u0435\u0441\u0442\u044C \u043D\u0435\u0447\u0442\u043E \u043E\u0431\u0449\u0435\u0435. \n<br>\n<img style='height: auto;width: auto; max-width: 200px;max-height: 200px;' src='/statics/girls.jpg'/>\n<br>\n\u041D\u043E\u043C\u0435\u0440 \u044D\u0442\u043E\u0433\u043E \u043E\u0431\u0449\u0435\u0433\u043E \u0441\u043E\u0441\u0442\u043E\u0438\u0442 \u0438\u0437 \u0434\u0432\u0443\u0445 \u0446\u0438\u0444\u0440. \u041F\u0435\u0440\u0432\u0430\u044F - \u0432\u0442\u043E\u0440\u043E\u0435 \u043D\u0430\u0442\u0443\u0440\u0430\u043B\u044C\u043D\u043E\u0435 \u0447\u0438\u0441\u043B\u043E, \u044F\u0432\u043B\u044F\u044E\u0449\u0435\u0435\u0441\u044F \u0442\u0440\u0435\u0442\u044C\u0435\u0439 \u0441\u0442\u0435\u043F\u0435\u043D\u044C\u044E \u043A\u0430\u043A\u043E\u0433\u043E-\u043B\u0438\u0431\u043E \u0434\u0440\u0443\u0433\u043E\u0433\u043E \u043D\u0430\u0442\u0443\u0440\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u0447\u0438\u0441\u043B\u0430; \u0432\u0442\u043E\u0440\u043E\u0435 \u2013 \u0441\u0443\u043C\u043C\u0430 \u0446\u0438\u0444\u0440 \u0441\u0430\u043C\u043E\u0433\u043E \u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E\u0433\u043E \u043F\u0440\u0438\u0431\u043B\u0438\u0436\u0435\u043D\u0438\u044F \u0447\u0438\u0441\u043B\u0430 \u043F\u0438.\n\u041D\u0430 \u0441\u0435\u0432\u0435\u0440\u043E-\u0437\u0430\u043F\u0430\u0434\u0435 \u043E\u0442 \u043D\u0435\u0433\u043E \u0434\u043E\u0440\u043E\u0436\u043D\u044B\u0439 \u0443\u043A\u0430\u0437\u0430\u0442\u0435\u043B\u044C. \u0420\u0430\u0441\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0434\u043E \u043C\u0435\u0434\u0432\u0435\u0436\u044C\u0435\u0439 \u043F\u0430\u0434\u0438?",
                "\n\u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0435\u043C \u0432\u0441\u043F\u043E\u043C\u043D\u0438\u0442\u044C \u0442\u0435\u043E\u0440\u0438\u044E \u0432\u0435\u0440\u043E\u044F\u0442\u043D\u043E\u0441\u0442\u0438. \n<br>\n<br>\n<img style='height: auto;width: auto; max-width: 250px;max-height: 250px;' src='/statics/formula.png'/>    \n<br>\n<br>\n\u0422\u0430\u043A \u0438 \u0431\u044B\u0442\u044C, \u043E\u0442 \u0432\u0430\u0441 \u043D\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u043F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C \u044D\u0442\u043E \u043D\u0435\u0440\u0430\u0432\u0435\u043D\u0441\u0442\u0432\u043E, \u043D\u043E \u0445\u043E\u0442\u044F \u0431\u044B \u0430\u0432\u0442\u043E\u0440\u0430 \u043F\u0440\u0438\u043F\u043E\u043C\u043D\u0438\u0442\u0435? :) \n\u0421\u044E\u0440\u043F\u0440\u0438\u0437-\u0441\u044E\u0440\u043F\u0440\u0438\u0437, \u0435\u0433\u043E \u0438\u043C\u0435\u043D\u0435\u043C \u043D\u0430\u0437\u0432\u0430\u043D\u0430 \u0443\u043B\u0438\u0446\u0430 \u0432 \u043D\u0430\u0448\u0435\u043C \u0433\u043E\u0440\u043E\u0434\u0435! \n\u0410 \u043D\u0430 \u0431\u043B\u0438\u0436\u0430\u0439\u0448\u0435\u0439 \u043F\u0430\u0440\u0430\u043B\u043B\u0435\u043B\u044C\u043D\u043E\u0439 \u0443\u043B\u0438\u0446\u0435 \u043D\u0430 \u0437\u0430\u043F\u0430\u0434\u0435 \u043D\u0430\u0445\u043E\u0434\u0438\u0442\u0441\u044F \u043D\u0435\u0431\u043E\u043B\u044C\u0448\u0430\u044F \u0430\u043B\u043B\u0435\u0439\u043A\u0430. \n\u041F\u043E\u0441\u0440\u0435\u0434\u0438 \u043D\u0435\u0451 \u2013 \u0442\u0435\u0445\u043D\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u0437\u0434\u0430\u043D\u0438\u0435 \u0441 \u0433\u0440\u0430\u0444\u0444\u0438\u0442\u0438, \u043A\u043E\u0442\u043E\u0440\u043E\u0435 \u0432\u0430\u043C \u0438 \u043D\u0443\u0436\u043D\u043E. \n\u0421\u043F\u0440\u0430\u0432\u0430 \u043E\u0442 \u0446\u0435\u043D\u0442\u0440\u0430\u043B\u044C\u043D\u043E\u0439 \u0434\u0435\u0432\u0443\u0448\u043A\u0438, \u043F\u0435\u0440\u0432\u044B\u0435 \u0447\u0435\u0442\u044B\u0440\u0435 \u0431\u0443\u043A\u0432\u044B \u043F\u043E\u0441\u043B\u0435 \u0442\u0440\u0435\u0443\u0433\u043E\u043B\u044C\u043D\u0438\u043A\u0430 \n"
            ]
        }
    ],
    bonus: {
        name: "Этап бонус. О программистах",
        quests: [
            ""
        ]
    }
};
function getDefaultData() {
    if (all_text) {
        return all_text;
    }
    return {
        stages: [
            {
                name: "Этап один. О полевых растениях",
                quests: [
                    "Это зеленое и растет на грядке в огроде у дедушки федора.",
                    "Это синее и не растет на грядке в огроде у дедушки федора.",
                    "Этоне растет вообще нигде, но может вас убить"
                ]
            },
            {
                name: "Этап два. О козлах отпущения",
                quests: [
                    "Козлы это животные. Назовите еще хоть одно животное.",
                    "Жирафы не козлы. Докажите это утверждение в трех словах",
                    "Путь самурая непрост. А каков путь козла-самурая?"
                ]
            },
            {
                name: "Этап три. О программистах",
                quests: [
                    "Как вы попали в сферу разработки ПО?",
                    "Какой был ваш первый язык программирования?",
                    "Сколько примерно будет 2^32?",
                    "Как сравнить две переменные типа double или float на равенство?",
                    "Что такое класс? Что такое объект? В чем разница?",
                    "Что такое член класса? Чем он отличается от других?",
                ]
            }],
        bonus: {
            name: "Этап бонус. О программистах",
            quests: [
                "Клонируйте овечку долли и докажите, что это ее копия",
                "Сколько попугает в жирафе? А есть он ходит по диагонали?",
                "Убейте какое-нибудь животное и пришлите фотографию"
            ]
        }
    };
}
var defaultData = getDefaultData();
var StageManager = (function () {
    function StageManager() {
        this.states = {};
        this.stagesNames = getStagesNames();
    }
    StageManager.prototype.setAnswers = function (token, stageId, answers) {
        var stage = this.getStage(token, stageId);
        if (!stage) {
            return null;
        }
        for (var _i = 0, answers_1 = answers; _i < answers_1.length; _i++) {
            var answer = answers_1[_i];
            if (!stage.questAnswers) {
                stage.questAnswers = {};
            }
            stage.questAnswers[answer.id] = answer;
        }
        return stage;
    };
    StageManager.prototype.getStagesNames = function () {
        return this.stagesNames;
    };
    StageManager.prototype.closeStage = function (token, stageId) {
        var stage = this.getStage(token, stageId);
        if (stage.status != 1 /* OPEN */) {
            return this.getAppState(token);
        }
        stage.status = 2 /* COMPLETED */;
        var nextStage = this.getNextStage(token, stage);
        if (nextStage && nextStage.status == 0 /* LOCKED */) {
            nextStage.status = 1 /* OPEN */;
        }
        return this.getAppState(token);
    };
    StageManager.prototype.getQuestionTexts = function (token, stageId) {
        var appState = this.getAppState(token);
        var stage = getStageById(appState, stageId);
        if (!stage || stage.status == 0 /* LOCKED */) {
            return null;
        }
        if (stage.status == 3 /* BONUS */) {
            return defaultData.bonus.quests;
        }
        var stageInfo = defaultData.stages[Number(stageId)];
        return stageInfo && stageInfo.quests;
    };
    StageManager.prototype.getNextStage = function (token, stage) {
        var appState = this.getAppState(token);
        if (stage.status == 3 /* BONUS */) {
            return null;
        }
        var showNumber = stage.showNumber;
        var nextStage = appState.stages[showNumber + 1];
        if (!nextStage) {
            return null;
        }
        return nextStage;
    };
    StageManager.prototype.getStage = function (token, stageId) {
        var appState = this.getAppState(token);
        if (!appState) {
            return null;
        }
        return getStageById(appState, stageId);
    };
    StageManager.prototype.getAppState = function (token) {
        var state = this.states[token];
        if (state) {
            return state;
        }
        return this.createAppState(token);
    };
    StageManager.prototype.createAppState = function (token) {
        console.log('Create state:' + token);
        var team = teamManager.findTeamByToken(token);
        if (!team) {
            return;
        }
        var stages = [];
        var appState = {
            bonus: null,
            stages: stages
        };
        var defaultStages = defaultData.stages;
        var startFromStage = team.startFromStage;
        var pushNumber = 0;
        for (var i = startFromStage; i < defaultStages.length; i++) {
            var status = i == startFromStage ? 1 /* OPEN */ : 0 /* LOCKED */;
            stages.push({
                id: String(i),
                status: status,
                showNumber: pushNumber++
            });
        }
        for (var i = 0; i < startFromStage; i++) {
            stages.push({
                id: String(i),
                status: 0 /* LOCKED */,
                showNumber: pushNumber++
            });
        }
        appState.bonus = {
            id: "bonus",
            status: 3 /* BONUS */,
            showNumber: pushNumber++
        };
        this.states[token] = appState;
        return appState;
    };
    return StageManager;
}());
function getStageById(state, stageId) {
    if (!state) {
        return null;
    }
    for (var _i = 0, _a = state.stages; _i < _a.length; _i++) {
        var stage = _a[_i];
        if (stage.id == stageId) {
            return stage;
        }
    }
    if (stageId == 'bonus') {
        return state.bonus;
    }
    return null;
}
function getStagesNames() {
    var result = {};
    var stages = defaultData.stages;
    for (var i = 0; i < stages.length; i++) {
        var rawStage = stages[i];
        result[String(i)] = rawStage.name;
    }
    result['bonus'] = defaultData.bonus.name;
    return result;
}
var stageManager = new StageManager();
var TeamImpl = (function () {
    function TeamImpl() {
    }
    return TeamImpl;
}());
var TEAMS = [];
TEAMS.push({
    name: "Тестовая админская команда",
    secretCode: "test",
    tokenId: "test",
    admin: true,
    startFromStage: 0
}, {
    name: "Самая тестовая команда 1",
    secretCode: "test2",
    tokenId: "test2",
    startFromStage: 1
});
var TeamManager = (function () {
    function TeamManager() {
    }
    TeamManager.prototype.findTeamByCode = function (secretCode) {
        if (!secretCode) {
            return null;
        }
        for (var _i = 0, TEAMS_1 = TEAMS; _i < TEAMS_1.length; _i++) {
            var team = TEAMS_1[_i];
            if (team.secretCode.toLocaleLowerCase() == secretCode.toLocaleLowerCase()) {
                return team;
            }
        }
        return null;
    };
    TeamManager.prototype.findTeamByToken = function (tokenId) {
        for (var _i = 0, TEAMS_2 = TEAMS; _i < TEAMS_2.length; _i++) {
            var team = TEAMS_2[_i];
            if (team.tokenId == tokenId) {
                return team;
            }
        }
        return null;
    };
    TeamManager.prototype.createTeam = function (name) {
        var secretCode = TeamManager.makeid();
        var newStartFrom = this.getNextStartFromStage();
        var team = {
            name: name,
            secretCode: secretCode,
            tokenId: secretCode,
            startFromStage: newStartFrom
        };
        TEAMS.push(team);
        return team;
    };
    TeamManager.prototype.listTeams = function () {
        return TEAMS;
    };
    TeamManager.prototype.login = function (secretCode) {
        var team = this.findTeamByCode(secretCode);
        if (team) {
            return {
                authenticated: true,
                name: team.name,
                token: team.tokenId,
                admin: team.admin
            };
        }
        return { authenticated: false };
    };
    TeamManager.prototype.getNextStartFromStage = function () {
        var lastTeam = TEAMS[TEAMS.length - 1];
        var startFromStage = lastTeam.startFromStage;
        var nextStage = startFromStage + 1;
        if (nextStage < defaultData.stages.length) {
            return nextStage;
        }
        return 0;
    };
    TeamManager.makeid = function () {
        var text = "";
        var possible = "abcdefghijklmnopqrstuvwxyz";
        for (var i = 0; i < 5; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
    };
    return TeamManager;
}());
var teamManager = new TeamManager();
var minimist = require('minimist');
var express = require('express');
var serveStatic = require('serve-static');
var bodyParser = require('body-parser');
var path = require('path');
var PORT = process.env.PORT || 8080;
var TARGET_PATH_MAPPING = {
    BUILD: './build',
    DIST: './dist'
};
var TARGET = minimist(process.argv.slice(2)).TARGET || 'BUILD';
var server = express();
server.use(bodyParser.json());
server.use(bodyParser.urlencoded({
    extended: true
}));
server
    .use(serveStatic(TARGET_PATH_MAPPING[TARGET]))
    .use('/statics', express.static(__dirname + '/statics'))
    .listen(PORT);
server.post('/quest-texts', function (req, res, next) {
    var request = req.body;
    res.json(processQuestTextsRequest(request));
});
server.post('/state', function (req, res, next) {
    console.log('requested state');
    var request = req.body;
    res.json(processStateRequest(request));
});
server.post('/login', function (req, res, next) {
    var request = req.body;
    if (!request.secretCode) {
        res.json({
            authenticated: false
        });
        return;
    }
    console.log('login ' + request.secretCode);
    res.json(processLoginRequest(request));
});
server.post('/save', function (req, res, next) {
    var request = req.body;
    console.log(request);
    res.json(processAnswerUpdateRequest(request));
});
server.post('/complete', function (req, res, next) {
    var request = req.body;
    var token = request.token;
    var options = processAnswerUpdateRequest(request);
    if (!options.success) {
        res.json({
            authenticated: false
        });
        return;
    }
    res.json(stageManager.closeStage(token, request.stageId));
});
server.get('/stage/*', function (req, res, next) {
    res.sendFile(path.join(__dirname, TARGET, '/index.html'));
});
server.get('/stages', function (req, res, next) {
    res.sendFile(path.join(__dirname, TARGET, '/index.html'));
});
server.post('/teams', function (req, res, next) {
    var request = req.body;
    console.log(request);
    res.json(processGetTeamsRequest(request));
});
server.post('/add-team', function (req, res, next) {
    var request = req.body;
    res.json(processAddTeamRequest(request));
});
function processStateRequest(req) {
    var token = req.token;
    var team = checkToken(token);
    if (!team) {
        console.log('no team found');
        return { success: false };
    }
    return {
        success: true,
        state: {
            appState: stageManager.getAppState(token),
            stagesNames: stageManager.getStagesNames()
        }
    };
}
function processAnswerUpdateRequest(req) {
    var token = req.token;
    var team = checkToken(token);
    if (!team) {
        return { success: false };
    }
    var answers = stageManager.setAnswers(token, req.stageId, req.answers);
    return {
        success: !!answers,
        stage: answers
    };
}
function processLoginRequest(req) {
    return teamManager.login(req.secretCode);
}
function processQuestTextsRequest(request) {
    var token = request.token;
    if (!checkToken(token)) {
        return { success: false };
    }
    var questTexts = stageManager.getQuestionTexts(token, request.stageId);
    if (!questTexts) {
        return {
            success: false
        };
    }
    return {
        success: true,
        questTexts: {
            stageId: request.stageId,
            quests: questTexts.map(function (el, i) {
                return {
                    id: i,
                    text: el
                };
            })
        }
    };
}
function processGetTeamsRequest(request) {
    var token = request.token;
    var team = checkToken(token);
    if (!team || !team.admin) {
        return {
            success: false
        };
    }
    var result = [];
    for (var _i = 0, TEAMS_3 = TEAMS; _i < TEAMS_3.length; _i++) {
        var team = TEAMS_3[_i];
        result.push({
            team: team,
            appState: stageManager.getAppState(team.tokenId)
        });
    }
    return {
        success: true,
        teams: result
    };
}
function processAddTeamRequest(request) {
    var team = teamManager.findTeamByToken(request.token);
    if (!team || !team.admin) {
        return {
            success: false
        };
    }
    var newTeam = teamManager.createTeam(request.teamName);
    return { success: !!newTeam };
}
function checkToken(token) {
    return teamManager.findTeamByCode(token);
}
console.log('Created server for: ' + TARGET + ', listening on port ' + PORT);
//# sourceMappingURL=server.js.map